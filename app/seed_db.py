import re
from sqlalchemy.orm import Session
from app.database import SessionLocal, engine
from app import models
import random

# Палитра "Старой библиотеки" (можешь дополнить своими цветами)
COLORS = ["#4B0002", "#013220", "#191970", "#2F4F4F", "#556B2F", "#3B2F2F"]

# Полный список книг (477 позиций)
books_text = """
1. Эпос о Гильгамеше (~XVIII–XVII вв. до н. э.)
2. Гомер — «Илиада» (VIII в. до н. э.)
3. Гомер — «Одиссея» (VIII в. до н. э.)
4. Софокл — «Царь Эдип» (V в. до н. э.)
5. Софокл — «Антигона» (V в. до н. э.)
6. Еврипид — «Медея» (431 г. до н. э.)
7. Эсхил — «Прикованный Прометей» (ок. 444 до н. э.)
8. Аристофан — «Лисистрата» (V в. до н. э.)
9. Аристофан — «Облака» (V в. до н. э.)
10. Платон — «Апология Сократа» (IV в. до н. э.)
11. Платон — «Пир» (IV в. до н. э.)
12. Платон — «Государство» (IV в. до н. э.)
13. Тит Лукреций Кар — «О природе вещей» (I в. до н. э.)
14. Вергилий — «Энеида» (29–19 гг. до н. э.)
15. Овидий — «Метаморфозы» (8 г. н. э.)
16. «Тысяча и одна ночь» (формировался X–XV вв.)
17. Омар Хайям — «Рубаи» (XI–XII вв.)
18. «Песнь о Нибелунгах» (ок. 1200)
19. «Слово о полку Ігоревім» (XII ст.)
20. Данте Алигьери — «Божественная комедия» (1320)
21. Джованни Бокаччо — «Декамерон» (1353)
22. Джеффри Чосер — «Кентерберийские рассказы» (1400)
23. Томас Мэлори — «Смерть Артура» (1485)
24. Эразм Роттердамский — «Похвальное слово Глупости» (1509)
25. Франсуа Рабле — «Гаргантюа и Пантагрюэль» (1533–1564)
26. Уильям Шекспир — «Ромео и Джульетта» (1595)
27. Уильям Шекспир — «Сон в летнюю ночь» (1596)
28. Уильям Шекспир — «Гамлет» (1601)
29. Уильям Шекспир — «Отелло» (1604)
30. Уильям Шекспир — «Король Лир» (1606)
31. Уильям Шекспир — «Макбет» (1606)
32. Уильям Шекспир — «Сонеты» (1609)
33. Мигель де Сервантес — «Дон Кихот» (том 1) (1605)
34. Мигель де Сервантес — «Дон Кихот» (том 2) (1615)
35. Лопе де Вега — «Собака на сене» (1618)
36. Джон Мильтон — «Потерянный рай» (1667)
37. Мольер — «Тартюф» (1664)
38. Мольер — «Мещанин во дворянстве» (1670)
39. Мольер — «Мнимый больной» (1673)
40. Даниэль Дефо — «Робинзон Крузо» (1719)
41. Джонатан Свифт — «Путешествия Гулливера» (1726)
42. Вольтер — «Кандид, или Оптимизм» (1759)
43. Иоганн Вольфганг Гёте — «Страдания юного Вертера» (1774)
44. Иоганн Вольфганг Гёте — «Фауст» (1808–1832)
45. Пьер де Бомарше — «Женитьба Фигаро» (1784)
46. Денис Фонвизин — «Недоросль» (1782)
47. Григорій Сковорода — «Сад божественних пісень» (XVIII ст.)
48. Григорій Сковорода — «Байки харківські» (1774)
49. Іван Котляревський — «Енеїда» (1798)
50. Іван Котляревський — «Наталка Полтавка» (1819)
51. Джейн Остин — «Чувство и чувствительность» (1811)
52. Джейн Остин — «Гордость и предубеждение» (1813)
53. Джейн Остин — «Доводы рассудка» (1817)
54. Эрнст Гофман — «Золотой горшок» (1814)
55. Эрнст Гофман — «Щелкунчик и Мышиный король» (1816)
56. Эрнст Гофман — «Песочный человек» (1817)
57. Эрнст Гофман — «Житейские воззрения кота Мурра» (1819)
58. Мэри Шелли — «Франкенштейн» (1818)
59. Вальтер Скотт — «Айвенго» (1819)
60. Вальтер Скотт — «Квентин Дорвард» (1823)
61. Александр Грибоедов — «Горе от ума» (1824)
62. Александр Пушкин — «Борис Годунов» (1825)
63. Джеймс Фенимор Купер — «Последний из могикан» (1826)
64. Джеймс Фенимор Купер — «Зверобой» (1841)
65. Стендаль — «Красное и черное» (1830)
66. Стендаль — «Пармская обитель» (1839)
67. Оноре де Бальзак — «Гобсек» (1830)
68. Оноре де Бальзак — «Шагреневая кожа» (1831)
69. Оноре де Бальзак — «Отец Горио» (1835)
70. Оноре де Бальзак — «Утраченные иллюзии» (1837–1843)
71. Оноре де Бальзак — «Тридцатилетняя женщина» (1842)
72. Оноре де Бальзак — «Блеск и нищета куртизанок» (1847)
73. Виктор Гюго — «Собор Парижской Богоматери» (1831)
74. Виктор Гюго — «Отверженные» (1862)
75. Виктор Гюго — «Человек, который смеется» (1869)
76. Николай Гоголь — «Вечера на хуторе близ Диканьки» (1831–1832)
77. Николай Гоголь — «Миргород» (Вий, Тарас Бульба) (1835)
78. Николай Гоголь — «Ревизор» (1836)
79. Александр Пушкин — «Евгений Онегин» (1833)
80. Александр Пушкин — «Повести Белкина» (1830)
81. Александр Пушкин — «Пиковая дама» (1834)
82. Александр Пушкин — «Капитанская дочка» (1836)
83. Александр Пушкин — «Руслан и Людмила» (1820)
84. Чарльз Диккенс — «Посмертные записки Пиквикского клуба» (1836)
85. Чарльз Диккенс — «Оливер Твист» (1838)
86. Чарльз Диккенс — «Рождественская песнь в прозе» (1843)
87. Чарльз Диккенс — «Дэвид Копперфильд» (1850)
88. Чарльз Диккенс — «Повесть о двух городах» (1859)
89. Чарльз Диккенс — «Большие надежды» (1861)
90. Михаил Лермонтов — «Герой нашего времени» (1840)
91. Михаил Лермонтов — «Мцыри» (1840)
92. Михаил Лермонтов — «Демон» (1839)
93. Тарас Шевченко — «Кобзар» (1840)
94. Николай Гоголь — «Петербургские повести» (Шинель, Нос) (1842)
95. Николай Гоголь — «Мертвые души» (1842)
96. Эдгар Аллан По — «Убийство на улице Морг» (1841)
97. Эдгар Аллан По — «Ворон» (1845)
98. Эдгар Аллан По — «Падение дома Ашеров» (1839)
99. Александр Дюма — «Граф Монте-Кристо» (1844)
100. Александр Дюма — «Три мушкетера» (1844)
101. Александр Дюма — «Двадцать лет спустя» (1845)
102. Александр Дюма — «Виконт де Бражелон» (1847)
103. Александр Дюма — «Королева Марго» (1845)
104. Проспер Мериме — «Кармен» (1845)
105. Шарлотта Бронте — «Джейн Эйр» (1847)
106. Эмили Бронте — «Грозовой перевал» (1847)
107. Уильям Теккерей — «Ярмарка тщеславия» (1848)
108. Федор Достоевский — «Белые ночи» (1848)
109. Герман Мелвилл — «Моби Дик» (1851)
110. Гюстав Флобер — «Госпожа Бовари» (1856)
111. Иван Тургенев — «Записки охотника» (1852)
112. Иван Тургенев — «Муму» (1852)
113. Иван Тургенев — «Дворянское гнездо» (1859)
114. Иван Тургенев — «Отцы и дети» (1862)
115. Иван Гончаров — «Обломов» (1859)
116. Уилки Коллинз — «Женщина в белом» (1859)
117. Уилки Коллинз — «Лунный камень» (1868)
118. Николай Лесков — «Леди Макбет Мценского уезда» (1865)
119. Николай Лесков — «Очарованный странник» (1873)
120. Николай Лесков — «Левша» (1881)
121. Льюис Кэрролл — «Алиса в Стране чудес» (1865)
122. Льюис Кэрролл — «Алиса в Зазеркалье» (1871)
123. Майн Рид — «Всадник без головы» (1865)
124. Федор Достоевский — «Преступление и наказание» (1866)
125. Федор Достоевский — «Игрок» (1866)
126. Федор Достоевский — «Идиот» (1869)
127. Федор Достоевский — «Бесы» (1872)
128. Федор Достоевский — «Братья Карамазовы» (1880)
129. Жюль Верн — «Дети капитана Гранта» (1868)
130. Жюль Верн — «20 000 лье под водой» (1870)
131. Жюль Верн — «Таинственный остров» (1874)
132. Жюль Верн — «Пятнадцатилетний капитан» (1878)
133. Лев Толстой — «Детство. Отрочество. Юность» (1852–1857)
134. Лев Толстой — «Война и мир» (1869)
135. Лев Толстой — «Анна Каренина» (1877)
136. Лев Толстой — «Смерть Ивана Ильича» (1886)
137. Лев Толстой — «Крейцерова соната» (1889)
138. Лев Толстой — «Воскресение» (1899)
139. Михаил Салтыков-Щедрин — «История одного города» (1870)
140. Михаил Салтыков-Щедрин — «Господа Головлевы» (1880)
141. Николай Некрасов — «Кому на Руси жить хорошо» (1874)
142. Генрик Ибсен — «Пер Гюнт» (1867)
143. Генрик Ибсен — «Кукольный дом» (1879)
144. Іван Нечуй-Левицький — «Микола Джеря» (1878)
145. Іван Нечуй-Левицький — «Кайдашева сім'я» (1879)
146. Марк Твен — «Приключения Тома Сойера» (1876)
147. Марк Твен — «Принц и нищий» (1881)
148. Марк Твен — «Приключения Гекльберри Финна» (1884)
149. Марк Твен — «Янки из Коннектикута при дворе короля Артура» (1889)
150. Іван Франко — «Захар Беркут» (1883)
151. Іван Франко — «Украдене щастя» (1893)
152. Іван Франко — «Перехресні стежки» (1900)
153. Роберт Льюис Стивенсон — «Остров сокровищ» (1883)
154. Роберт Льюис Стивенсон — «Странная история доктора Джекила и мистера Хайда» (1886)
155. Роберт Льюис Стивенсон — «Черная стрела» (1888)
156. Роберт Льюис Стивенсон — «Владетель Баллантре» (1889)
157. Джером К. Джером — «Трое в лодке, не считая собаки» (1889)
158. Ги де Мопассан — «Пышка» (1880)
159. Ги де Мопассан — «Милый друг» (1885)
160. Эмиль Золя — «Дамское счастье» (1883)
161. Эмиль Золя — «Жерминаль» (1885)
162. Іван Карпенко-Карий — «Мартин Боруля» (1886)
163. Іван Карпенко-Карий — «Сто тисяч» (1889)
164. Артур Конан Дойл — «Этюд в багровых тонах» (1887)
165. Артур Конан Дойл — «Знак четырех» (1890)
166. Артур Конан Дойл — «Приключения Шерлока Холмса» (сборник) (1892)
167. Артур Конан Дойл — «Собака Баскервилей» (1902)
168. Артур Конан Дойл — «Затерянный мир» (1912)
169. Кнут Гамсун — «Голод» (1890)
170. Кнут Гамсун — «Плоды земли» (1917)
171. Оскар Уайльд — «Портрет Дориана Грея» (1890)
172. Оскар Уайльд — «Как важно быть серьезным» (1895)
173. Томас Харди — «Тэсс из рода д’Эрбервиллей» (1891)
174. Редьярд Киплинг — «Книга джунглей» (1894)
175. Редьярд Киплинг — «Ким» (1901)
176. Герберт Уэллс — «Машина времени» (1895)
177. Герберт Уэллс — «Человек-невидимка» (1897)
178. Герберт Уэллс — «Война миров» (1898)
179. Антон Чехов — «Чайка» (1896)
180. Антон Чехов — «Дядя Ваня» (1897)
181. Антон Чехов — «Три сестры» (1900)
182. Антон Чехов — «Вишневый сад» (1903)
183. Антон Чехов — «Каштанка», «Дама с собачкой» (Рассказы)
184. Брэм Стокер — «Дракула» (1897)
185. Этель Лилиан Войнич — «Овод» (1897)
186. Александр Куприн — «Олеся» (1898)
187. Александр Куприн — «Поединок» (1905)
188. Александр Куприн — «Гранатовый браслет» (1910)
189. Александр Куприн — «Яма» (1915)
190. Джозеф Конрад — «Сердце тьмы» (1899)
191. Джозеф Конрад — «Лорд Джим» (1900)
192. Василь Стефаник — «Синя книжечка» (1899)
193. Василь Стефаник — «Камінний хрест» (1900)
194. Л. Фрэнк Баум — «Удивительный волшебник из страны Оз» (1900)
195. Томас Манн — «Будденброки» (1901)
196. Томас Манн — «Смерть в Венеции» (1912)
197. Томас Манн — «Волшебная гора» (1924)
198. Джек Лондон — «Зов предков» (1903)
199. Джек Лондон — «Морской волк» (1904)
200. Джек Лондон — «Белый Клык» (1906)
201. Джек Лондон — «Любовь к жизни» (1907)
202. Джек Лондон — «Мартин Иден» (1909)
203. Джек Лондон — «Смок Беллью» (1912)
204. Джек Лондон — «Маленькая хозяйка большого дома» (1915)
205. Джек Лондон — «Сердца трех» (1920)
206. О. Генри — «Короли и капуста» (1904)
207. О. Генри — «Дары волхвов» и другие рассказы (1906)
208. Сельма Лагерлеф — «Чудесное путешествие Нильса с дикими гусями» (1906)
209. Г.К. Честертон — «Неведение отца Брауна» (1911)
210. Леся Українка — «Лісова пісня» (1911)
211. Леся Українка — «Камінний господар» (1912)
212. Михайло Коцюбинський — «Fata Morgana» (1903–1910)
213. Михайло Коцюбинський — «Intermezzo» (1908)
214. Михайло Коцюбинський — «Тіні забутих предків» (1911)
215. Марсель Пруст — «В сторону Свана» (1913)
216. Марсель Пруст — «Под сенью девушек в цвету» (1919)
217. Марсель Пруст — «У Германтов» (1920)
218. Марсель Пруст — «Содом и Гоморра» (1921)
219. Марсель Пруст — «Пленница» (1923)
220. Марсель Пруст — «Беглянка» (1925)
221. Марсель Пруст — «Обретенное время» (1927)
222. Бернард Шоу — «Пигмалион» (1913)
223. Николай Кун — «Легенды и мифы Древней Греции» (1914)
224. Джеймс Джойс — «Дублинцы» (1914)
225. Джеймс Джойс — «Улисс» (1922)
226. Густав Майринк — «Голем» (1914)
227. Франц Кафка — «Превращение» (1915)
228. Франц Кафка — «Процесс» (1925)
229. Франц Кафка — «Замок» (1926)
230. Владимир Маяковский — «Облако в штанах» (1915)
231. Уильям Сомерсет Моэм — «Бремя страстей человеческих» (1915)
232. Уильям Сомерсет Моэм — «Луна и грош» (1919)
233. Уильям Сомерсет Моэм — «Театр» (1937)
234. Иван Бунин — «Господин из Сан-Франциско» (1915)
235. Иван Бунин — «Легкое дыхание» (1916)
236. Иван Бунин — «Окаянные дни» (1926)
237. Иван Бунин — «Жизнь Арсеньева» (1930)
238. Иван Бунин — «Темные аллеи» (1943)
239. Володимир Винниченко — «Записки кирпатого Мефістофеля» (1917)
240. Володимир Винниченко — «Сонячна машина» (1928)
241. Джеймс Стивенс — «Ирландские предания» (1920)
242. Евгений Замятин — «Мы» (1920)
243. Ярослав Гашек — «Похождения бравого солдата Швейка» (1921–1923)
244. Рафаэль Сабатини — «Одиссея капитана Блада» (1922)
245. Рафаэль Сабатини — «Хроники капитана Блада» (1931)
246. Ф. Скотт Фицджеральд — «Загадочная история Бенджамина Баттона» (1922)
247. Фрэнсис Скотт Фицджеральд — «Великий Гэтсби» (1925)
248. Фрэнсис Скотт Фицджеральд — «Ночь нежна» (1934)
249. Александр Грин — «Алые паруса» (1923)
250. Александр Грин — «Бегущая по волнам» (1928)
251. Алексей Толстой — «Аэлита» (1923)
252. Алексей Толстой — «Гиперболоид инженера Гарина» (1927)
253. Алексей Толстой — «Пётр Первый» (1930–1945)
254. Алексей Толстой — «Хождение по мукам» (Трилогия) (1922–1941)
255. Корней Чуковский — «От двух до пяти» (1928)
256. Микола Хвильовий — «Я (Романтика)» (1924)
257. Микола Хвильовий — «Санаторійна зона» (1924)
258. Михаил Булгаков — «Белая гвардия» (1925)
259. Михаил Булгаков — «Записки юного врача» (1925)
260. Михаил Булгаков — «Собачье сердце» (1925)
261. Михаил Булгаков — «Роковые яйца» (1925)
262. Михаил Булгаков — «Дни Турбиных» (1926)
263. Михаил Булгаков — «Бег» (1928)
264. Михаил Булгаков — «Театральный роман» (1936)
265. Михаил Булгаков — «Мастер и Маргарита» (1940)
266. Теодор Драйзер — «Американская трагедия» (1925)
267. Теодор Драйзер — «Финансист» (1912)
268. Теодор Драйзер — «Титан» (1914)
269. Теодор Драйзер — «Стоик» (1947)
270. Марина Цветаева — «Лирика» (1920-е)
271. Исаак Бабель — «Конармия» (1926)
272. Исаак Бабель — «Одесские рассказы» (1931)
273. Эрнест Хемингуэй — «Фиеста (И восходит солнце)» (1926)
274. Эрнест Хемингуэй — «Прощай, оружие!» (1929)
275. Эрнест Хемингуэй — «По ком звонит колокол» (1940)
276. Эрнест Хемингуэй — «Старик и море» (1952)
277. Герман Гессе — «Степной волк» (1927)
278. Герман Гессе — «Игра в бисер» (1943)
279. Александр Беляев — «Голова профессора Доуэля» (1925)
280. Александр Беляев — «Человек-амфибия» (1928)
281. Александр Беляев — «Продавец воздуха» (1929)
282. Александр Беляев — «Ариэль» (1941)
283. Ильф и Петров — «Двенадцать стульев» (1928)
284. Ильф и Петров — «Золотой теленок» (1931)
285. Ильф и Петров — «Одноэтажная Америка» (1937)
286. Остап Вишня — «Мисливські усмішки», Фейлетони (1920–1950-і)
287. Валер'ян Підмогильний — «Місто» (1928)
288. Дэвид Герберт Лоуренс — «Любовник леди Чаттерлей» (1928)
289. Михаил Шолохов — «Тихий Дон» (1928–1940)
290. Михаил Шолохов — «Судьба человека» (1956)
291. Эрих Мария Ремарк — «На Западном фронте без перемен» (1929)
292. Эрих Мария Ремарк — «Три товарища» (1936)
293. Эрих Мария Ремарк — «Триумфальная арка» (1945)
294. Уильям Фолкнер — «Шум и ярость» (1929)
295. Андрей Платонов — «Чевенгур» (1929)
296. Андрей Платонов — «Котлован» (1930)
297. Олдос Хаксли — «О дивный новый мир» (1932)
298. Луи-Фердинанд Селин — «Путешествие на край ночи» (1932)
299. Генри Миллер — «Тропик Рака» (1934)
300. Юрій Яновський — «Вершники» (1935)
301. Маргарет Митчелл — «Унесенные ветром» (1936)
302. Дж. Р. Р. Толкин — «Хоббит, или Туда и обратно» (1937)
303. Дж. Р. Р. Толкин — «Властелин колец: Братство Кольца» (1954)
304. Дж. Р. Р. Толкин — «Властелин колец: Две крепости» (1954)
305. Дж. Р. Р. Толкин — «Властелин колец: Возвращение короля» (1955)
306. Дж. Р. Р. Толкин — «Сильмарриллион» (1977)
307. Вениамин Каверин — «Два капитана» (1938–1944)
308. Владимир Набоков — «Защита Лужина» (1930)
309. Владимир Набоков — «Приглашение на казнь» (1936)
310. Владимир Набоков — «Дар» (1938)
311. Владимир Набоков — «Лолита» (1955)
312. Жан-Поль Сартр — «Тошнота» (1938)
313. Джон Стейнбек — «О мышах и людях» (1937)
314. Джон Стейнбек — «Гроздья гнева» (1939)
315. Агата Кристи — «Убийство в Восточном экспрессе» (1934)
316. Агата Кристи — «Десять негритят» (1939)
317. Альбер Камю — «Миф о Сизифе» (1942)
318. Альбер Камю — «Посторонний» (1942)
319. Альбер Камю — «Чума» (1947)
320. Антуан де Сент-Экзюпери — «Планета людей» (1939)
321. Антуан де Сент-Экзюпери — «Маленький принц» (1943)
322. Іван Багряний — «Тигролови» (1944)
323. Іван Багряний — «Сад Гетсиманський» (1950)
324. Хорхе Луис Борхес — «Вымыслы» (1944)
325. Хорхе Луис Борхес — «Алеф» (1949)
326. Астрид Линдгрен — «Пеппи Длинныйчулок» (1945)
327. Астрид Линдгрен — «Малыш и Карлсон, который живет на крыше» (1955)
328. Джордж Оруэлл — «Скотный двор» (1945)
329. Джордж Оруэлл — «1984» (1949)
330. Джозеф Кэмпбелл — «Тысячеликий герой» (1949)
331. Айзек Азимов — «Я, Робот» (1950)
332. Айзек Азимов — «Основание» (книга 1) (1951)
333. Айзек Азимов — «Основание и Империя» (книга 2) (1952)
334. Айзек Азимов — «Второе Основание» (книга 3) (1953)
335. Джером Сэлинджер — «Над пропастью во ржи» (1951)
336. Сэмюэл Беккет — «В ожидании Годо» (1952)
337. Рэй Брэдбери — «Марсианские хроники» (1950)
338. Рэй Брэдбери — «451 градус по Фаренгейту» (1953)
339. Рэй Брэдбери — «Вино из одуванчиков» (1957)
340. Уильям Голдинг — «Повелитель мух» (1954)
341. Олександр Довженко — «Україна в огні» (1943)
342. Олександр Довженко — «Зачарована Десна» (1956)
343. Виктор Драгунский — «Денискины рассказы» (1959)
344. Джек Керуак — «В дороге» (1957)
345. Борис Пастернак — «Доктор Живаго» (1957)
346. Трумен Капоте — «Завтрак у Тиффани» (1958)
347. Уильям Берроуз — «Голый завтрак» (1959)
348. Харпер Ли — «Убить пересмешника» (1960)
349. Джон Апдайк — «Кролик, беги» (1960)
350. Роберт Хайнлайн — «Звездный десант» (1959)
351. Роберт Хайнлайн — «Чужак в чужой стране» (1961)
352. Станислав Лем — «Эдем» (1959)
353. Станислав Лем — «Солярис» (1961)
354. Станислав Лем — «Непобедимый» (1964)
355. Станислав Лем — «Сказки роботов» (1964)
356. Джозеф Хеллер — «Уловка-22» (1961)
357. Кен Кизи — «Пролетая над гнездом кукушки» (1962)
358. Энтони Бёрджесс — «Заводной апельсин» (1962)
359. Генрих Бёлль — «Глазами клоуна» (1963)
360. Хулио Кортасар — «Игра в классики» (1963)
361. Курт Воннегут — «Колыбель для кошки» (1963)
362. Курт Воннегут — «Бойня номер пять» (1969)
363. Аркадий и Борис Стругацкие — «Трудно быть богом» (1964)
364. Аркадий и Борис Стругацкие — «Понедельник начинается в субботу» (1965)
365. Аркадий и Борис Стругацкие — «Обитаемый остров» (1969)
366. Аркадий и Борис Стругацкие — «Пикник на обочине» (1972)
367. Фрэнк Герберт — «Дюна» (1965)
368. Фрэнк Герберт — «Мессия Дюны» (1969)
369. Фрэнк Герберт — «Дети Дюны» (1976)
370. Фрэнк Герберт — «Бог-Император Дюны» (1981)
371. Фрэнк Герберт — «Еретики Дюны» (1984)
372. Фрэнк Герберт — «Капитул Дюны» (1985)
373. Джон Фаулз — «Коллекционер» (1963)
374. Джон Фаулз — «Волхв» (1965)
375. Габриэль Гарсиа Маркес — «Сто лет одиночества» (1967)
376. Габриэль Гарсиа Маркес — «Осень патриарха» (1975)
377. Филип Дик — «Мечтают ли андроиды об электроовцах?» (1968)
378. Филип Дик — «Убик» (1969)
379. Олесь Гончар — «Собор» (1968)
380. Патрик О’Брайан — «Командир и штурман» (Начало цикла о Джеке Обри) (1969)
381. Урсула Ле Гуин — «Волшебник Земноморья» (1968)
382. Урсула Ле Гуин — «Левая рука тьмы» (1969)
383. Венедикт Ерофеев — «Москва — Петушки» (1970)
384. Роджер Желязны — «Хроники Амбера» (книги 1-5, Корвин) (1970–1978)
385. Роджер Желязны — «Хроники Амбера» (книги 6-10, Мерлин) (1985–1991)
386. Гавриил Троепольский — «Белый Бим Черное ухо» (1971)
387. Хантер Томпсон — «Страх и отвращение в Лас-Вегасе» (1971)
388. Василь Стус — «Веселий цвинтар», «Палімпсести» (1970-і)
389. Василий Шукшин — Рассказы («Калина красная») (1970-е)
390. Григір Тютюнник — «Климко», Новели (1970-і)
391. Стивен Кинг — «Кэрри» (1974)
392. Стивен Кинг — «Сияние» (1977)
393. Стивен Кинг — «Противостояние» (1978)
394. Стивен Кинг — «Четыре сезона» (сборник повестей) (1982)
395. Стивен Кинг — «Оно» (1986)
396. Стивен Кинг — «Зеленая миля» (1996)
397. Стивен Кинг — «Стрелок» (Темная башня I) (1982)
398. Стивен Кинг — «Извлечение троих» (Темная башня II) (1987)
399. Стивен Кинг — «Бесплодные земли» (Темная башня III) (1991)
400. Стивен Кинг — «Колдун и кристалл» (Темная башня IV) (1997)
401. Стивен Кинг — «Волки Кальи» (Темная башня V) (2003)
402. Стивен Кинг — «Песнь Сюзанны» (Темная башня VI) (2004)
403. Стивен Кинг — «Темная башня» (Темная башня VII) (2004)
404. Стивен Кинг — «Ветер сквозь замочную скважину» (Темная башня 4.5) (2012)
405. Стивен Кинг — «Как писать книги» (2000)
406. Ліна Костенко — «Маруся Чурай» (1979)
407. Ліна Костенко — «Берестечко» (1999)
408. Умберто Эко — «Имя розы» (1980)
409. Умберто Эко — «Маятник Фуко» (1988)
410. Уильям Гибсон — «Нейромант» (1984)
411. Милан Кундера — «Невыносимая легкость бытия» (1984)
412. Патрик Зюскинд — «Парфюмер» (1985)
413. Сергей Довлатов — «Зона» (1982)
414. Сергей Довлатов — «Заповедник» (1983)
415. Сергей Довлатов — «Чемодан» (1986)
416. Иосиф Бродский — «Полторы комнаты», Стихотворения (1986)
417. Анджей Сапковский — «Последнее желание» (Ведьмак 1) (1986)
418. Анджей Сапковский — «Меч Предназначения» (Ведьмак 2) (1992)
419. Анджей Сапковский — «Кровь эльфов» (Ведьмак 3) (1994)
420. Анджей Сапковский — «Час Презрения» (Ведьмак 4) (1995)
421. Анджей Сапковский — «Крещение огнем» (Ведьмак 5) (1996)
422. Анджей Сапковский — «Башня Ласточки» (Ведьмак 6) (1997)
423. Анджей Сапковский — «Владычица Озера» (Ведьмак 7) (1999)
424. Анджей Сапковский — «Сезон гроз» (Ведьмак 8) (2013)
425. Терри Пратчетт — «Цвет волшебства» (Плоский мир 1) (1983)
426. Кристофер Воглер — «Путешествие писателя» (1992)
427. Юрій Андрухович — «Рекреації» (1992)
428. Юрій Андрухович — «Московіада» (1993)
429. Юрій Андрухович — «Перверзія» (1996)
430. Жозе Сарамаго — «Слепота» (1995)
431. Виктор Пелевин — «Чапаев и Пустота» (1996)
432. Виктор Пелевин — «Generation П» (1999)
433. Оксана Забужко — «Польові дослідження з українського сексу» (1996)
434. Чак Паланик — «Бойцовский клуб» (1996)
435. Джордж Р. Р. Мартин — «Игра престолов» (1996)
436. Джордж Р. Р. Мартин — «Битва королей» (1998)
437. Джордж Р. Р. Мартин — «Буря мечей» (2000)
438. Джордж Р. Р. Мартин — «Пир стервятников» (2005)
439. Джордж Р. Р. Мартин — «Танец с драконами» (2011)
440. Светлана Алексиевич — «Чернобыльская молитва» (1997)
441. Сергей Лукьяненко — «Лабиринт отражений» (1997)
442. Сергей Лукьяненко — «Фальшивые зеркала» (1999)
443. Сергей Лукьяненко — «Прозрачные витражи» (2000)
444. Сергей Лукьяненко — «Ночной дозор» (1998)
445. Сергей Лукьяненко — «Дневной дозор» (2000)
446. Сергей Лукьяненко — «Сумеречный дозор» (2003)
447. Сергей Лукьяненко — «Последний дозор» (2005)
448. Джоан Роулинг — «Гарри Поттер и Философский камень» (1997)
449. Джоан Роулинг — «Гарри Поттер и Тайная комната» (1998)
450. Джоан Роулинг — «Гарри Поттер и Узник Азкабана» (1999)
451. Джоан Роулинг — «Гарри Поттер и Кубок огня» (2000)
452. Джоан Роулинг — «Гарри Поттер и Орден Феникса» (2003)
453. Джоан Роулинг — «Гарри Поттер и Принц-полукровка» (2005)
454. Джоан Роулинг — «Гарри Поттер и Дары Смерти» (2007)
455. Орхан Памук — «Имя мне — Красный» (1998)
456. Борис Акунин — «Азазель» (1998)
457. Борис Акунин — «Турецкий гамбит» (1998)
458. Борис Акунин — «Левиафан» (1998)
459. Борис Акунин — «Смерть Ахиллеса» (1998)
460. Харуки Мураками — «Норвежский лес» (1987)
461. Харуки Мураками — «Кафка на пляже» (2002)
462. Нил Гейман — «Американские боги» (2001)
463. Кормак Маккарти — «Дорога» (2006)
464. Ольга Токарчук — «Бегуны» (2007)
465. Сергій Жадан — «Депеш Мод» (2004)
466. Сергій Жадан — «Ворошиловград» (2010)
467. Сергій Жадан — «Інтернат» (2017)
468. Наринэ Абгарян — «Манюня» (2010)
469. Юваль Ной Харари — «Sapiens: Краткая история человечества» (2011)
470. Фредрик Бакман — «Вторая жизнь Уве» (2012)
471. Евгений Водолазкин — «Лавр» (2012)
472. Донна Тартт — «Щегол» (2013)
473. Гузель Яхина — «Зулейха открывает глаза» (2015)
474. Стивен Фрай — «Миф. Греческие мифы в пересказе» (2017)
475. Ілларіон Павлюк — «Я бачу, вас цікавить пітьма» (2020)
476. Кадзуо Исигуро — «Клара и Солнце» (2021)
477. Макс Кідрук — «Нові темні віки» (2023)
"""


def parse_books(text):
    parsed_data = []
    lines = text.strip().split('\n')

    for line in lines:
        line = line.strip()
        if not line or not re.match(r'^\d+\.', line):
            continue

        # 1. Извлекаем всё, что в последних скобках (это всегда дата/период)
        # Находим последнюю открывающую скобку
        start_paren = line.rfind('(')
        end_paren = line.rfind(')')

        date_str = "Неизвестно"
        content_part = line

        if start_paren != -1 and end_paren != -1:
            date_str = line[start_paren + 1:end_paren].strip()
            content_part = line[:start_paren].strip()

        # 2. Убираем порядковый номер в начале (напр. "1. ")
        content_part = re.sub(r'^\d+\.\s*', '', content_part)

        # 3. Разделяем Автора и Название
        # Твой список в основном использует " — " (длинное тире с пробелами)
        if " — " in content_part:
            author, title = content_part.split(" — ", 1)
        else:
            # Если тире нет (как в "Эпос о Гильгамеше"), считаем автора анонимным
            author = "Классика / Аноним"
            title = content_part

        # 4. Финальная чистка кавычек и лишних пробелов
        title = title.replace('«', '').replace('»', '').strip()
        author = author.strip()

        # 5. Генерация "года для сортировки" (sort_year)
        # Логика: если есть цифры, берем первую найденную. Если "в. до н. э.", делаем год отрицательным.
        sort_year = 2025  # Дефолт
        numbers = re.findall(r'\d+', date_str)
        if numbers:
            year = int(numbers[0])
            if "до н. э." in date_str or "до н.э." in date_str:
                sort_year = -year * 100 if "в." in date_str else -year
            elif "в." in date_str:
                sort_year = (year - 1) * 100
            else:
                sort_year = year

        parsed_data.append({
            "author": author,
            "title": title,
            "year_raw": date_str,
            "sort_year": sort_year
        })

    return parsed_data


def seed():
    db = SessionLocal()

    # ВНИМАНИЕ: Добавь эту строку, чтобы снести старую структуру на Render
    models.Base.metadata.drop_all(bind=engine)

    # Создаем таблицы в облаке Render
    models.Base.metadata.create_all(bind=engine)

    # Получаем распарсенные данные (убедись, что parse_books возвращает year_raw и sort_year)
    data = parse_books(books_text)

    for item in data:
        # 1. Ищем автора или создаем нового
        author = db.query(models.Author).filter_by(full_name=item['author']).first()
        if not author:
            author = models.Author(full_name=item['author'])
            db.add(author)
            db.flush()  # Фиксируем автора, чтобы получить его author.id

        # 2. Создаем книгу с учетом структуры твоей модели в Postgres
        book = models.Book(
            title=item['title'],
            author_id=author.id,
            year_raw=item['year_raw'],  # Исправлено: теперь ключ совпадает с парсером
            sort_year=item['sort_year'],  # Добавляем для правильного порядка на полке
            hex_color=random.choice(COLORS),  # Назначаем случайный "кожаный" цвет
            cover_image="default_spine.jpg"
        )
        db.add(book)

    db.commit()
    db.close()
    print(f"Готово! Библиотека наполнена. Загружено книг: {len(data)}")


if __name__ == "__main__":
    seed()
