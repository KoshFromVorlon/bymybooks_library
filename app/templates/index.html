<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>ByMyBooks — Величественная Библиотека</title>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --wood: url('https://www.transparenttextures.com/patterns/dark-wood.png');
            --gold: #d4af37;
            --shelf-color: #3d2b1f;
        }

        body {
            margin: 0;
            background: #1a110a;
            font-family: 'EB Garamond', serif;
            color: #fdf5e6;
            overflow-x: hidden;
        }

        .vault { padding: 40px 10px; background-image: var(--wood); min-height: 100vh; }

        .shelf-row {
            display: flex;
            justify-content: space-around;
            align-items: flex-end;
            margin-bottom: 140px;
            padding: 0 20px;
            border-bottom: 55px solid var(--shelf-color);
            background-image: var(--wood);
            box-shadow: 0 30px 60px rgba(0,0,0,1);
            position: relative;
        }

        .book-stack {
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            width: 700px;
            position: relative;
            margin-bottom: -2px;
            align-items: center;
        }

        .book-hor {
            width: 100%;
            height: 85px;
            margin-bottom: 1px;
            position: relative;
            cursor: pointer;
            /* ИСПРАВЛЕНИЕ: добавлено плавное затухание тени при возврате на полку */
            transition: transform 0.5s ease, filter 0.5s ease, box-shadow 0.5s ease;
            display: flex;
            align-items: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.8);
            border-radius: 3px 6px 6px 3px;
            border-bottom: 3px solid rgba(0,0,0,0.4);

            scroll-margin-top: calc(50vh - 42px);
        }

        .book-hor:hover {
            transform: translateX(40px) !important;
            z-index: 1000;
            filter: brightness(1.2);
        }

        .book-hor:target {
            transform: translateX(50px) !important;
            filter: brightness(1.3);
            border-right: 4px solid var(--gold);
            z-index: 1000;
            animation: pulse-glow 2s infinite;
        }

        @keyframes pulse-glow {
            0% { box-shadow: -5px 0 15px rgba(212, 175, 55, 0.4); }
            50% { box-shadow: -5px 0 35px rgba(212, 175, 55, 1); }
            100% { box-shadow: -5px 0 15px rgba(212, 175, 55, 0.4); }
        }

        .spine-svg {
            width: 100%;
            height: 100%;
            padding: 0 25px;
            display: flex;
            align-items: center;
        }

        .title-svg-container {
            flex: 1 1 auto;
            height: 100%;
            margin-right: 15px;
            overflow: hidden;
        }

        .meta-svg-container {
            flex: 0 0 auto;
            width: 240px;
            height: 100%;
            margin-left: 15px;
        }

        .gold-line {
            stroke: var(--gold);
            stroke-width: 2;
            stroke-linecap: round;
            filter: drop-shadow(0 0 5px var(--gold));
            height: 60px;
            align-self: center;
        }

        .text-title {
            fill: var(--gold);
            font-weight: 800;
            text-transform: uppercase;
            font-family: 'EB Garamond', serif;
            font-size: 50px;
            dominant-baseline: middle;
        }

        .text-meta {
            fill: var(--gold);
            font-weight: 700;
            font-family: 'EB Garamond', serif;
            opacity: 0.9;
            text-anchor: middle;
        }

        .meta-author { font-size: 28px; }
        .meta-year { font-size: 22px; opacity: 0.7; }

        #global-cover-popup {
            position: fixed;
            width: 450px;
            height: 630px;
            background-size: cover;
            background-position: center;
            border: 6px solid var(--gold);
            border-radius: 8px;
            box-shadow: 0 0 120px rgba(0,0,0,1);
            z-index: 10000;
            display: none;
            pointer-events: none;
        }
    </style>
</head>
<body>

<div id="global-cover-popup"></div>

<div class="vault">
    {% for row in rows %}
    <div class="shelf-row">
        {% for stack in row %}
        <div class="book-stack">
            {% for book in stack %}
            {% set offset = range(-15, 15) | random %}
            <div id="book-{{ book.id }}"
                 class="book-hor"
                 style="background-color: {{ book.hex_color }}; transform: translateX({{ offset }}px);"
                 onmouseenter="showCover(this, '/static/covers/{{ book.id }}.jpg')"
                 onmouseleave="hideCover()"
                 onclick="location.href='/book/{{ book.id }}'">

                <div class="spine-svg">

                    <div class="title-svg-container">
                        <svg class="title-svg" width="100%" height="100%">
                            <text x="0" y="50%" class="text-title">{{ book.title }}</text>
                        </svg>
                    </div>

                    <svg class="gold-line" width="2" height="60">
                         <line x1="1" y1="0" x2="1" y2="60" stroke="var(--gold)" stroke-width="2" stroke-linecap="round"/>
                    </svg>

                    <div class="meta-svg-container">
                        <svg class="meta-svg" width="100%" height="100%" overflow="visible">
                            <g class="meta-group">
                                <text x="0" y="0" class="text-meta meta-author">{{ book.author.full_name }}</text>
                                <text x="0" y="30" class="text-meta meta-year">{{ book.year_raw }}</text>
                            </g>
                        </svg>
                    </div>
                </div>

            </div>
            {% endfor %}
        </div>
        {% endfor %}
    </div>
    {% endfor %}
</div>

<script>
    const popup = document.getElementById('global-cover-popup');

    function showCover(element, imgUrl) {
        popup.style.backgroundImage = `url('${imgUrl}')`;
        popup.style.display = 'block';

        const rect = element.getBoundingClientRect();
        const popupWidth = 450;
        const popupHeight = 630;

        let left = rect.right + 40;
        let top = rect.top - (popupHeight / 3);

        if (left + popupWidth > window.innerWidth) {
            left = rect.left - popupWidth - 40;
        }

        if (top < 10) top = 10;
        if (top + popupHeight > window.innerHeight) {
            top = window.innerHeight - popupHeight - 10;
        }

        popup.style.left = `${left}px`;
        popup.style.top = `${top}px`;
    }

    function hideCover() {
        popup.style.display = 'none';
    }

    function fitSvgContent(svgElement, contentElement, align) {
        const bbox = contentElement.getBBox();
        if (bbox.width === 0 || bbox.height === 0) return;

        const paddingX = 5;
        const paddingY = 5;

        const vBox = `${bbox.x - paddingX} ${bbox.y - paddingY} ${bbox.width + paddingX * 2} ${bbox.height + paddingY * 2}`;

        svgElement.setAttribute('viewBox', vBox);
        svgElement.setAttribute('preserveAspectRatio', `${align} meet`);
    }

    document.fonts.ready.then(() => {
        document.querySelectorAll('.title-svg').forEach(svg => {
            const textElement = svg.querySelector('text');
            fitSvgContent(svg, textElement, 'xMinYMid');
        });

        document.querySelectorAll('.meta-svg').forEach(svg => {
            const groupElement = svg.querySelector('.meta-group');
            fitSvgContent(svg, groupElement, 'xMaxYMid');
        });
    });

    // === ЛОГИКА ГАШЕНИЯ КНИГИ ===
    // Функция, которая проверяет, есть ли хэш книги, и запускает таймер на 10 секунд
    function manageBookGlow() {
        if (window.location.hash.startsWith('#book-')) {
            setTimeout(() => {
                // history.replaceState убирает якорь из адресной строки без скачка страницы вверх
                history.replaceState(null, null, window.location.pathname + window.location.search);
            }, 10000);
        }
    }

    // Запускаем проверку при загрузке страницы (когда возвращаемся по кнопке "На полку")
    window.addEventListener('DOMContentLoaded', manageBookGlow);

    // Запускаем проверку, если хэш изменился без перезагрузки
    window.addEventListener('hashchange', manageBookGlow);
</script>

</body>
</html>