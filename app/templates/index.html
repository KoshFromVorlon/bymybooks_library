<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>ByMyBooks — Величественная Библиотека</title>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --wood: url('https://www.transparenttextures.com/patterns/dark-wood.png');
            --gold: #d4af37;
            --shelf-color: #3d2b1f;
        }

        body {
            margin: 0;
            background: #1a110a;
            font-family: 'EB Garamond', serif;
            color: #fdf5e6;
            overflow-x: hidden;
        }

        .vault { padding: 40px 10px; background-image: var(--wood); min-height: 100vh; }

        .shelf-row {
            display: flex;
            justify-content: space-around;
            align-items: flex-end;
            margin-bottom: 140px;
            padding: 0 20px;
            border-bottom: 55px solid var(--shelf-color);
            background-image: var(--wood);
            box-shadow: 0 30px 60px rgba(0,0,0,1);
            position: relative;
        }

        .book-stack {
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            width: 700px;
            position: relative;
            margin-bottom: -2px;
            align-items: center;
        }

        .book-hor {
            width: 100%;
            height: 85px;
            margin-bottom: 1px;
            position: relative;
            cursor: pointer;
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1),
                        filter 0.6s ease,
                        box-shadow 0.6s ease;
            display: flex;
            align-items: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.8);
            border-radius: 3px 6px 6px 3px;
            border-bottom: 3px solid rgba(0,0,0,0.4);
            scroll-margin-top: calc(50vh - 42px);
        }

        .book-hor:hover {
            transform: translateX(40px) !important;
            z-index: 1000;
            filter: brightness(1.2);
        }

        /* === ИСПРАВЛЕННЫЙ КЛАСС ПОДСВЕТКИ === */
        .active-glow {
            transform: translateX(50px) !important;
            filter: brightness(1.3);
            border-right: 4px solid var(--gold);
            z-index: 1000;
            animation: pulse-glow 2s infinite;
        }

        @keyframes pulse-glow {
            0% { box-shadow: -5px 0 15px rgba(212, 175, 55, 0.4); }
            50% { box-shadow: -5px 0 35px rgba(212, 175, 55, 1); }
            100% { box-shadow: -5px 0 15px rgba(212, 175, 55, 0.4); }
        }

        .spine-svg {
            width: 100%;
            height: 100%;
            padding: 0 25px;
            display: flex;
            align-items: center;
        }

        .title-svg-container { flex: 1 1 auto; height: 100%; margin-right: 15px; overflow: hidden; }
        .meta-svg-container { flex: 0 0 auto; width: 240px; height: 100%; margin-left: 15px; }

        .gold-line {
            stroke: var(--gold);
            stroke-width: 2;
            stroke-linecap: round;
            filter: drop-shadow(0 0 5px var(--gold));
            height: 60px;
            align-self: center;
        }

        .text-title {
            fill: var(--gold);
            font-weight: 800;
            text-transform: uppercase;
            font-family: 'EB Garamond', serif;
            font-size: 50px;
            dominant-baseline: middle;
        }

        .text-meta {
            fill: var(--gold);
            font-weight: 700;
            font-family: 'EB Garamond', serif;
            opacity: 0.9;
            text-anchor: middle;
        }

        .meta-author { font-size: 28px; }
        .meta-year { font-size: 22px; opacity: 0.7; }

        #global-cover-popup {
            position: fixed;
            width: 450px;
            height: 630px;
            background-size: cover;
            background-position: center;
            border: 6px solid var(--gold);
            border-radius: 8px;
            box-shadow: 0 0 120px rgba(0,0,0,1);
            z-index: 10000;
            display: none;
            pointer-events: none;
        }
    </style>
</head>
<body>

<div id="global-cover-popup"></div>

<div class="vault">
    {% for row in rows %}
    <div class="shelf-row">
        {% for stack in row %}
        <div class="book-stack">
            {% for book in stack %}
            {% set offset = range(-15, 15) | random %}
            <div id="book-{{ book.id }}"
                 class="book-hor"
                 style="background-color: {{ book.hex_color }}; transform: translateX({{ offset }}px);"
                 onmouseenter="showCover(this, '/static/covers/{{ book.id }}.jpg')"
                 onmouseleave="hideCover()"
                 onclick="location.href='/book/{{ book.id }}'">

                <div class="spine-svg">
                    <div class="title-svg-container">
                        <svg class="title-svg" width="100%" height="100%">
                            <text x="0" y="50%" class="text-title">{{ book.title }}</text>
                        </svg>
                    </div>
                    <svg class="gold-line" width="2" height="60">
                         <line x1="1" y1="0" x2="1" y2="60" stroke="var(--gold)" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                    <div class="meta-svg-container">
                        <svg class="meta-svg" width="100%" height="100%" overflow="visible">
                            <g class="meta-group">
                                <text x="0" y="0" class="text-meta meta-author">{{ book.author.full_name }}</text>
                                <text x="0" y="30" class="text-meta meta-year">{{ book.year_raw }}</text>
                            </g>
                        </svg>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endfor %}
    </div>
    {% endfor %}
</div>

<script>
    const popup = document.getElementById('global-cover-popup');

    function showCover(element, imgUrl) {
        popup.style.backgroundImage = `url('${imgUrl}')`;
        popup.style.display = 'block';
        const rect = element.getBoundingClientRect();
        let left = rect.right + 40;
        let top = rect.top - 210;
        if (left + 450 > window.innerWidth) left = rect.left - 490;
        popup.style.left = `${left}px`;
        popup.style.top = `${top}px`;
    }

    function hideCover() { popup.style.display = 'none'; }

    function fitSvgContent(svgElement, contentElement, align) {
        const bbox = contentElement.getBBox();
        if (bbox.width === 0) return;
        const vBox = `${bbox.x - 5} ${bbox.y - 5} ${bbox.width + 10} ${bbox.height + 10}`;
        svgElement.setAttribute('viewBox', vBox);
        svgElement.setAttribute('preserveAspectRatio', `${align} meet`);
    }

    document.fonts.ready.then(() => {
        document.querySelectorAll('.title-svg').forEach(svg => fitSvgContent(svg, svg.querySelector('text'), 'xMinYMid'));
        document.querySelectorAll('.meta-svg').forEach(svg => fitSvgContent(svg, svg.querySelector('.meta-group'), 'xMaxYMid'));

        // ВЫЗЫВАЕМ ПОДСВЕТКУ ПОСЛЕ ЗАГРУЗКИ ШРИФТОВ
        manageBookGlow();
    });

    // === УЛУЧШЕННАЯ ЛОГИКА ГАШЕНИЯ ===
    function manageBookGlow() {
        const hash = window.location.hash;
        if (hash.startsWith('#book-')) {
            const bookId = hash.substring(1); // получаем book-ID
            const targetBook = document.getElementById(bookId);

            if (targetBook) {
                // 1. Скроллим к книге (уже работает через scroll-margin-top)
                targetBook.scrollIntoView({ behavior: 'smooth', block: 'start' });

                // 2. Включаем свечение через класс
                targetBook.classList.add('active-glow');

                // 3. Выключаем свечение ровно через 10 секунд
                setTimeout(() => {
                    targetBook.classList.remove('active-glow');
                    // Убираем хэш из URL, чтобы при обновлении страницы свечение не началось заново
                    history.replaceState(null, null, window.location.pathname);
                }, 10000);
            }
        }
    }
</script>

</body>
</html>