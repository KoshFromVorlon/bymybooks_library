<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ByMyBooks — Величественная Библиотека</title>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --wood: url('https://www.transparenttextures.com/patterns/dark-wood.png');
            --gold: #d4af37;
            --shelf-color: #3d2b1f;
        }

        body {
            margin: 0;
            background: #1a110a;
            font-family: 'EB Garamond', serif;
            color: #fdf5e6;
            overflow-x: hidden;
        }

        .vault { padding: 40px 10px; background-image: var(--wood); min-height: 100vh; }

        .shelf-row {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: flex-end;
            margin-bottom: 140px;
            padding: 0 2%;
            border-bottom: 55px solid var(--shelf-color);
            background-image: var(--wood);
            box-shadow: 0 30px 60px rgba(0,0,0,1);
            position: relative;

            /* === ИЗМЕНЕНИЕ 1: Увеличили отступ между стопками === */
            gap: 60px; /* Было 20px, стало 60px для "воздуха" */
        }

        .book-stack {
            display: flex;
            flex-direction: column;
            justify-content: flex-end;

            /* === ИЗМЕНЕНИЕ 2: Чуть уменьшили ширину === */
            /* Было 32%, ставим 29%, чтобы компенсировать увеличившийся gap и оставить 3 колонки */
            width: 29%;
            max-width: 700px;
            min-width: 320px;

            position: relative;
            margin-bottom: -2px;
            align-items: center;
            flex-grow: 1;
        }

        /* === АДАПТИВНОСТЬ === */
        @media (max-width: 1300px) { /* Чуть раньше включаем режим 2 колонок */
            .book-stack {
                width: 45%;
            }
        }

        @media (max-width: 768px) {
            .book-stack {
                width: 95%;
            }
            .shelf-row {
                padding-bottom: 20px;
            }
        }

        .book-hor {
            width: 100%;
            margin-bottom: 1px;
            position: relative;
            cursor: pointer;
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1),
                        filter 0.6s ease,
                        box-shadow 0.6s ease;
            box-shadow: 0 4px 10px rgba(0,0,0,0.8);
            border-radius: 3px 6px 6px 3px;
            border-bottom: 3px solid rgba(0,0,0,0.4);
            scroll-margin-top: calc(50vh - 42px);

            display: flex;
            align-items: center;
            overflow: hidden;
        }

        .book-hor:hover {
            transform: translateX(20px) !important;
            z-index: 1000;
            filter: brightness(1.2);
        }

        .active-glow {
            transform: translateX(30px) !important;
            filter: brightness(1.3);
            border-right: 4px solid var(--gold);
            z-index: 1000;
            animation: pulse-glow 2s infinite;
        }

        @keyframes pulse-glow {
            0% { box-shadow: -5px 0 15px rgba(212, 175, 55, 0.4); }
            50% { box-shadow: -5px 0 35px rgba(212, 175, 55, 1); }
            100% { box-shadow: -5px 0 15px rgba(212, 175, 55, 0.4); }
        }

        /* === СТРУКТУРА КОРЕШКА === */
        .spine-left {
            flex: 1;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2px 8px;
            box-sizing: border-box;
        }

        .spine-divider {
            flex: 0 0 10px;
            height: 90%;
            border-left: 2px solid var(--gold);
            border-right: 2px solid var(--gold);
            opacity: 0.9;
            box-shadow: 0 0 3px rgba(212, 175, 55, 0.4);
            margin: 0 2px;
        }

        .spine-right {
            flex: 0 0 25%;
            width: 25%;
            max-width: 25%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2px 5px;
            box-sizing: border-box;
        }

        svg {
            display: block;
            width: 100%;
            height: 100%;
            overflow: visible;
        }

        text {
            fill: var(--gold);
            font-family: 'EB Garamond', serif;
            text-anchor: middle;
            dominant-baseline: central;
        }

        .text-title {
            font-weight: 800;
            text-transform: uppercase;
            font-size: 60px;
            filter: drop-shadow(1px 1px 0px rgba(0,0,0,0.5));
        }

        #global-cover-popup {
            position: fixed;
            width: 450px;
            height: 630px;
            background-size: cover;
            background-position: center;
            border: 6px solid var(--gold);
            border-radius: 8px;
            box-shadow: 0 0 120px rgba(0,0,0,1);
            z-index: 10000;
            display: none;
            pointer-events: none;
        }
    </style>
</head>
<body>

<div id="global-cover-popup"></div>

<div class="vault">
    {% for row in rows %}
    <div class="shelf-row">
        {% for stack in row %}
        <div class="book-stack">
            {% for book in stack %}
            {% set offset = range(-10, 10) | random %}

            {% set p = book.pages if book.pages > 0 else 300 %}
            {% set thickness = 45 + (p * 0.12) %}
            {% if thickness > 140 %}{% set thickness = 140 %}{% endif %}

            <div id="book-{{ book.id }}"
                 class="book-hor"
                 style="height: {{ thickness|int }}px; background-color: {{ book.hex_color or '#2b2013' }}; transform: translateX({{ offset }}px);"
                 onmouseenter="showCover(this, '/static/covers/{{ '%03d' | format(book.position) }}_{{ book.slug }}.jpg?v={{ range(1, 10000) | random }}')"
                 onmouseleave="hideCover()"
                 onclick="window.open('/book/{{ book.id }}', '_blank')">

                <div class="spine-left">
                    <svg class="svg-auto-fit" width="100%" height="100%" preserveAspectRatio="xMidYMid meet">
                        <text x="0" y="0" class="text-title">{{ book.title }}</text>
                    </svg>
                </div>

                <div class="spine-divider"></div>

                <div class="spine-right">
                    <svg class="svg-auto-fit" width="100%" height="100%" preserveAspectRatio="xMidYMid meet">
                        <text class="text-meta-block" x="0" y="0">
                            <tspan x="0" dy="-0.6em" font-weight="700" font-size="40">{{ book.author.full_name }}</tspan>
                            <tspan x="0" dy="1.2em" font-weight="500" font-size="32" fill-opacity="0.9">{{ book.year_raw }}</tspan>
                        </text>
                    </svg>
                </div>

            </div>
            {% endfor %}
        </div>
        {% endfor %}
    </div>
    {% endfor %}
</div>

<script>
    const popup = document.getElementById('global-cover-popup');

    function showCover(element, imgUrl) {
        popup.style.backgroundImage = `url('${imgUrl}')`;
        popup.style.display = 'block';

        const rect = element.getBoundingClientRect();
        const popupWidth = 450;
        const popupHeight = 630;
        let left = rect.right + 40;
        let top = rect.top - (popupHeight / 3);

        if (left + popupWidth > window.innerWidth) left = rect.left - popupWidth - 40;
        if (top < 10) top = 10;
        if (top + popupHeight > window.innerHeight) top = window.innerHeight - popupHeight - 10;

        popup.style.left = `${left}px`;
        popup.style.top = `${top}px`;
    }

    function hideCover() {
        popup.style.display = 'none';
    }

    function autoFitText() {
        document.querySelectorAll('.svg-auto-fit').forEach(svg => {
            const content = svg.querySelector('text');
            if (!content) return;
            const bbox = content.getBBox();
            if (bbox.width === 0 || bbox.height === 0) return;
            const paddingX = 4;
            const paddingY = 4;
            const vBoxX = bbox.x - paddingX;
            const vBoxY = bbox.y - paddingY;
            const vBoxW = bbox.width + (paddingX * 2);
            const vBoxH = bbox.height + (paddingY * 2);
            svg.setAttribute('viewBox', `${vBoxX} ${vBoxY} ${vBoxW} ${vBoxH}`);
        });
    }

    document.fonts.ready.then(() => {
        autoFitText();
        manageBookGlow();
    });

    window.addEventListener('resize', autoFitText);
    window.onload = autoFitText;

    function manageBookGlow() {
        const hash = window.location.hash;
        if (hash.startsWith('#book-')) {
            const bookId = hash.substring(1);
            const targetBook = document.getElementById(bookId);
            if (targetBook) {
                targetBook.scrollIntoView({ behavior: 'smooth', block: 'center' });
                targetBook.classList.add('active-glow');
                setTimeout(() => {
                    targetBook.classList.remove('active-glow');
                    history.replaceState(null, null, window.location.pathname + window.location.search);
                }, 10000);
            }
        }
    }
    window.addEventListener('hashchange', manageBookGlow);
</script>

</body>
</html>